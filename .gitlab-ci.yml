include: /.gitlab-ci.templates.yml

stages:
  - Triggers

trigger-core-laravel:
  stage: Triggers
  variables:
    DEPLOY_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA
    ENVIRONMENT_NAME: $ENVIRONMENT_NAME
  trigger:
    include: /lara-app/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: '($CI_PIPELINE_SOURCE != "pipeline") && (($CI_MERGE_REQUEST_ID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" && $CI_MERGE_REQUEST_TITLE !~ /^Draft:/) || $CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_REF_NAME == "production" || $CI_COMMIT_REF_NAME == "staging")'
      changes:
        - .gitlab-ci.yml
        - lara-app/**/*
        - .gitlab-ci.templates.yml
        - devops/build/*
        - devops/k8s/**/core-laravel.yml
        - devops/k8s/**/queue-worker.yml
        - devops/k8s/**/kustomization.yml
        - devops/k8s/**/ingresses.yml

trigger-pex-app:
  stage: Triggers
  variables:
    DEPLOY_COMMIT_SHORT_SHA: $DEPLOY_COMMIT_SHORT_SHA
    ENVIRONMENT_NAME: $ENVIRONMENT_NAME
    DEPLOYMENT_URL: $DEPLOYMENT_URL
  trigger:
    include: /devops/external-apps-ci-configs/pex-app.gitlab-ci.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "pipeline" && $SERVICE_NAME == "pex-app"

trigger-pex-admin:
  stage: Triggers
  variables:
    DEPLOY_COMMIT_SHORT_SHA: $DEPLOY_COMMIT_SHORT_SHA
    ENVIRONMENT_NAME: $ENVIRONMENT_NAME
    DEPLOYMENT_URL: $DEPLOYMENT_URL
  trigger:
    include: /devops/external-apps-ci-configs/pex-admin.gitlab-ci.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "pipeline" && $SERVICE_NAME == "pex-admin"

trigger-pex-storybook:
  stage: Triggers
  variables:
    DEPLOY_COMMIT_SHORT_SHA: $DEPLOY_COMMIT_SHORT_SHA
    ENVIRONMENT_NAME: $ENVIRONMENT_NAME
    DEPLOYMENT_URL: $DEPLOYMENT_URL
  trigger:
    include: /devops/external-apps-ci-configs/storybook.gitlab-ci.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "pipeline" && $SERVICE_NAME == "pex-storybook"
