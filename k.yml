apiVersion: v1
data:
  ACCESS_TOKEN_EXPIRATION_TIME_PER_MINUTES: "3"
  APP_DEBUG: "false"
  APP_KEY: base64:yQhAdFdboNEdYLvoysezy0/gyKxDdwJM9SsqdtCzNhw=
  APP_NAME: Laravel
  APP_URL: https://core-lara-33e1254e7d-paylibero-nightly.apps.ir-thr-ba1.arvancaas.ir
  BROADCAST_DRIVER: log
  CACHE_DRIVER: file
  DB_CONNECTION: mysql
  DB_DATABASE: laravel
  DEPLOY_MODE: "true"
  FILESYSTEM_DISK: local
  LOG_CHANNEL: stack
  LOG_DEPRECATIONS_CHANNEL: "null"
  LOG_LEVEL: debug
  MAIL_MAILER: "smtp"
  MAIL_HOST: "send.ahasend.com"
  MAIL_PORT: "587"
  MAIL_ENCRYPTION: "tls"
  MAIL_USERNAME: "10cSOoYX8R"
  MAIL_PASSWORD: "WTDByC0hlia2ic5JtafnreIH"
  MAIL_FROM_ADDRESS: "noreply@paylibero.ir"
  MAIL_FROM_NAME: "Paylibero"
  MEMCACHED_HOST: 127.0.0.1
  MYSQL_DATABASE: laravel
  QUEUE_CONNECTION: redis
  REDIS_CLIENT: predis
  REFRESH_TOKEN_EXPIRATION_TIME_PER_MINUTES: "14400"
  SENTRY_LARAVEL_DSN: https://2e6c8a38ddf48ff4820e3cd0e466a6e1@sentry.hamravesh.com/6536
  SENTRY_TRACES_SAMPLE_RATE: "1.0"
  SESSION_DRIVER: redis
  SESSION_LIFETIME: "120"
kind: ConfigMap
metadata:
  name: core-laravel
  namespace: paylibero-nightly
---
apiVersion: v1
data:
  redis.conf: |-
    bind 0.0.0.0
    requirepass paylibero0100
    user default on +@all ~* >paylibero0100
    port 6379
kind: ConfigMap
metadata:
  name: redis-config
  namespace: paylibero-nightly
---
apiVersion: v1
kind: Service
metadata:
  name: core-laravel
  namespace: paylibero-nightly
spec:
  ports:
    - port: 8000
      protocol: TCP
      targetPort: 8000
  selector:
    app: core-laravel
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: phpmyadmin
  name: phpmyadmin
  namespace: paylibero-nightly
spec:
  ports:
    - name: phpmyadmin
      port: 80
      protocol: TCP
      targetPort: 80
  selector:
    app: phpmyadmin
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: paylibero-nightly
spec:
  ports:
    - port: 6379
  selector:
    app: redis
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: redis-gui
  namespace: paylibero-nightly
spec:
  ports:
    - port: 80
      protocol: TCP
      targetPort: 8081
  selector:
    app: redis-gui
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: core-laravel
  namespace: paylibero-nightly
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: core-laravel
  strategy:
    rollingUpdate:
      maxSurge: 75%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: core-laravel
        commit-short-sha: commit_22b4c882
    spec:
      containers:
        - env:
            - name: APP_ENV
              value: nightly
            - name: APP_URL
              value: https://nightly.paylibero.ir
            - name: DB_HOST
              value: paylibero-db-mysql-headless
            - name: DB_PORT
              value: "3306"
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: core-laravel-mysql-db
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: core-laravel-mysql-db
            - name: RECAPTCHA_V3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: secret_key
                  name: google-recaptcha
            - name: RECAPTCHA_V3_SITE_KEY
              valueFrom:
                secretKeyRef:
                  key: site_key
                  name: google-recaptcha
            - name: RECAPTCHA_V3_ENABLE
              value: "false"
            - name: REDIS_HOST
              value: redis
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: redis-auth
            - name: ZIBAL_CALLBACK_URL
              value: https://nightly.paylibero.ir/api/gateway/callback
            - name: FINNOTECH_BASE_URL
              value: https://sandboxapi.finnotech.ir
            - name: FINNOTECH_CLIENT_ID
              value: paylibero
            - name: FINNOTECH_TOKEN
              valueFrom:
                secretKeyRef:
                  key: token
                  name: finno-tech
            - name: FRONTEND_URL_AFTER_PAYMENT
              value: https://nightly.paylibero.ir/dashboard/trades
            - name: SANCTUM_STATEFUL_DOMAINS
              value: localhost:4000,core-lara-33e1254e7d-paylibero-nightly.apps.ir-thr-ba1.arvancaas.ir,nightly.paylibero.ir
            - name: SESSION_DOMAIN
              value: .paylibero.ir
            - name: AWS_URL
              value: https://files.paylibero.ir/
            - name: AWS_DEFAULT_REGION
              value: Simin
            - name: AWS_BUCKET
              value: paylibero-nightly-core
            - name: FILESYSTEM_DISK
              value: s3
            - name: AWS_USE_PATH_STYLE_ENDPOINT
              value: "false"
            - name: AWS_ENDPOINT
              value: https://s3.ir-thr-at1.arvanstorage.ir
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  key: id
                  name: file-storage
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: access-key
                  name: file-storage
            - name: HOSTNAME
              value: php
          envFrom:
            - configMapRef:
                name: core-laravel
          image: registry.hamdocker.ir/paylibero/build-core-laravel:22b4c882
          imagePullPolicy: Always
          livenessProbe:
            failureThreshold: 5
            initialDelaySeconds: 90
            periodSeconds: 60
            successThreshold: 1
            tcpSocket:
              port: 8000
            timeoutSeconds: 1
          name: core-laravel
          ports:
            - containerPort: 8000
              protocol: TCP
          readinessProbe:
            failureThreshold: 5
            initialDelaySeconds: 20
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 8000
            timeoutSeconds: 1
          resources:
            limits:
              cpu: 500m
              ephemeral-storage: 200M
              memory: 1G
            requests:
              cpu: 500m
              ephemeral-storage: 200M
              memory: 1G
          volumeMounts:
            - mountPath: /var/www/storage/oauth
              name: passport-oauth-volume
      imagePullSecrets:
        - name: hamdocker
      initContainers:
        - args:
            - |
              cd /var/www
              php artisan optimize:clear
              php artisan optimize
              php artisan migrate --force
              php artisan generate:swagger
          command:
            - /bin/sh
            - -c
          env:
            - name: APP_ENV
              value: nightly
            - name: APP_URL
              value: https://nightly.paylibero.ir
            - name: DB_HOST
              value: paylibero-db-mysql-headless
            - name: DB_PORT
              value: "3306"
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: core-laravel-mysql-db
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: core-laravel-mysql-db
            - name: RECAPTCHA_V3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: secret_key
                  name: google-recaptcha
            - name: RECAPTCHA_V3_SITE_KEY
              valueFrom:
                secretKeyRef:
                  key: site_key
                  name: google-recaptcha
            - name: RECAPTCHA_V3_ENABLE
              value: "false"
            - name: REDIS_HOST
              value: redis
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: redis-auth
            - name: MAIL_USERNAME
              value: 10cSOoYX8R
            - name: MAIL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: ahasend
            - name: ZIBAL_CALLBACK_URL
              value: https://nightly.paylibero.ir/api/gateway/callback
            - name: FINNOTECH_BASE_URL
              value: https://sandboxapi.finnotech.ir
            - name: FINNOTECH_CLIENT_ID
              value: paylibero
            - name: FINNOTECH_TOKEN
              valueFrom:
                secretKeyRef:
                  key: token
                  name: finno-tech
            - name: FRONTEND_URL_AFTER_PAYMENT
              value: https://nightly.paylibero.ir/dashboard/trades
            - name: SANCTUM_STATEFUL_DOMAINS
              value: localhost:4000,core-lara-33e1254e7d-paylibero-nightly.apps.ir-thr-ba1.arvancaas.ir,nightly.paylibero.ir
            - name: SESSION_DOMAIN
              value: .paylibero.ir
            - name: AWS_URL
              value: https://files.paylibero.ir/
            - name: AWS_DEFAULT_REGION
              value: Simin
            - name: AWS_BUCKET
              value: paylibero-nightly-core
            - name: FILESYSTEM_DISK
              value: s3
            - name: AWS_USE_PATH_STYLE_ENDPOINT
              value: "false"
            - name: AWS_ENDPOINT
              value: https://s3.ir-thr-at1.arvanstorage.ir
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  key: id
                  name: file-storage
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: access-key
                  name: file-storage
            - name: HOSTNAME
              value: php
          envFrom:
            - configMapRef:
                name: core-laravel
          image: registry.hamdocker.ir/paylibero/build-core-laravel:22b4c882
          name: laravel-setup
          volumeMounts:
            - mountPath: /var/www/storage/oauth
              name: passport-oauth-volume
      restartPolicy: Always
      volumes:
        - name: passport-oauth-volume
          persistentVolumeClaim:
            claimName: core-laravel-passport-oauth-pvc
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: phpmyadmin
  name: phpmyadmin
  namespace: paylibero-nightly
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: phpmyadmin
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: phpmyadmin
    spec:
      containers:
        - env:
            - name: PMA_HOST
              value: paylibero-db-mysql-headless
            - name: PMA_PORT
              value: "3306"
            - name: PMA_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: core-laravel-mysql-db
            - name: PMA_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: core-laravel-mysql-db
          image: phpmyadmin/phpmyadmin:latest
          imagePullPolicy: Always
          name: phpmyadmin
          ports:
            - containerPort: 80
              protocol: TCP
          resources:
            limits:
              cpu: 128m
              memory: 256Mi
            requests:
              cpu: 64m
              memory: 128Mi
      restartPolicy: Always
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: queue-worker
  namespace: paylibero-nightly
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: queue-worker
  template:
    metadata:
      labels:
        app: queue-worker
        commit-short-sha: commit_22b4c882
    spec:
      containers:
        - env:
            - name: APP_ENV
              value: nightly
            - name: DB_HOST
              value: paylibero-db-mysql-headless
            - name: DB_PORT
              value: "3306"
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: core-laravel-mysql-db
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: core-laravel-mysql-db
            - name: RECAPTCHA_V3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: secret_key
                  name: google-recaptcha
            - name: RECAPTCHA_V3_SITE_KEY
              valueFrom:
                secretKeyRef:
                  key: site_key
                  name: google-recaptcha
            - name: RECAPTCHA_V3_ENABLE
              value: "false"
            - name: REDIS_HOST
              value: redis
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: redis-auth
            - name: MAIL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: ahasend
            - name: HOSTNAME
              value: queue
          envFrom:
            - configMapRef:
                name: core-laravel
          image: registry.hamdocker.ir/paylibero/build-core-laravel:22b4c882
          name: queue-worker
          ports:
            - containerPort: 8000
              protocol: TCP
          resources:
            limits:
              cpu: 128m
              memory: 256Mi
            requests:
              cpu: 64m
              memory: 128Mi
          volumeMounts:
            - mountPath: /var/log/supervisor
              name: worker-logs
      imagePullSecrets:
        - name: hamdocker
      restartPolicy: Always
      volumes:
        - name: worker-logs
          persistentVolumeClaim:
            claimName: worker-logs-pvc
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: paylibero-nightly
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - command:
            - redis-server
            - /usr/local/etc/redis/redis.conf
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: redis-auth
          image: redis:7.2.5
          name: redis
          ports:
            - containerPort: 6379
          resources:
            limits:
              cpu: 128m
              memory: 256Mi
            requests:
              cpu: 64m
              memory: 128Mi
          volumeMounts:
            - mountPath: /data
              name: redis-storage
            - mountPath: /usr/local/etc/redis/redis.conf
              name: redis-config
              subPath: redis.conf
      volumes:
        - name: redis-storage
          persistentVolumeClaim:
            claimName: redis-vol
        - configMap:
            name: redis-config
          name: redis-config
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: redis-gui
  name: redis-gui
  namespace: paylibero-nightly
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: redis-gui
  template:
    metadata:
      labels:
        app: redis-gui
    spec:
      containers:
        - env:
            - name: REDIS_HOST
              value: redis
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: redis-auth
          image: rediscommander/redis-commander:latest
          name: redis-gui
          ports:
            - containerPort: 8081
          resources:
            limits:
              cpu: 128m
              memory: 256Mi
            requests:
              cpu: 64m
              memory: 128Mi
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-http
    kubernetes.io/change-cause: kubectl apply --record=true --filename=-
    nginx.ingress.kubernetes.io/backend-protocol: HTTP
    nginx.ingress.kubernetes.io/client-body-buffer-size: 64k
    nginx.ingress.kubernetes.io/client-header-buffer-size: 100k
    nginx.ingress.kubernetes.io/http2-max-header-size: 96k
    nginx.ingress.kubernetes.io/large-client-header-buffers: 4 100k
    nginx.ingress.kubernetes.io/load-balance: ewma
    nginx.ingress.kubernetes.io/proxy-body-size: 150m
    nginx.ingress.kubernetes.io/proxy-buffer-size: 96k
    nginx.ingress.kubernetes.io/proxy-read-timeout: "1000"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "1000"
  name: paylibero
  namespace: paylibero-nightly
spec:
  ingressClassName: nginx
  rules:
    - host: core-lara-33e1254e7d-paylibero-nightly.apps.ir-thr-ba1.arvancaas.ir
      http:
        paths:
          - backend:
              service:
                name: core-laravel
                port:
                  number: 8000
            path: /
            pathType: Prefix
    - host: pex-app-33e1254e7d-paylibero-nightly.apps.ir-thr-ba1.arvancaas.ir
      http:
        paths:
          - backend:
              service:
                name: pex-app
                port:
                  number: 8000
            path: /
            pathType: ImplementationSpecific
    - host: redis-33e1254e7d-paylibero-nightly.apps.ir-thr-ba1.arvancaas.ir
      http:
        paths:
          - backend:
              service:
                name: redis-gui
                port:
                  number: 80
            path: /
            pathType: ImplementationSpecific
    - host: phpmyadmin-33e1254e7d-paylibero-nightly.apps.ir-thr-ba1.arvancaas.ir
      http:
        paths:
          - backend:
              service:
                name: phpmyadmin
                port:
                  number: 80
            path: /
            pathType: ImplementationSpecific
    - host: nightly.paylibero.ir
      http:
        paths:
          - backend:
              service:
                name: pex-app
                port:
                  number: 8000
            path: /
            pathType: Prefix
          - backend:
              service:
                name: core-laravel
                port:
                  number: 8000
            path: /sanctum/csrf-cookie
            pathType: Prefix
          - backend:
              service:
                name: core-laravel
                port:
                  number: 8000
            path: /api
            pathType: ImplementationSpecific
    - host: nightly.admin.paylibero.ir
      http:
        paths:
          - backend:
              service:
                name: pex-admin
                port:
                  number: 8000
            path: /
            pathType: ImplementationSpecific
          - backend:
              service:
                name: core-laravel
                port:
                  number: 8000
            path: /sanctum/csrf-cookie
            pathType: Prefix
          - backend:
              service:
                name: core-laravel
                port:
                  number: 8000
            path: /api
            pathType: ImplementationSpecific
    - host: storybook.paylibero.ir
      http:
        paths:
          - backend:
              service:
                name: pex-storybook
                port:
                  number: 80
            path: /
            pathType: ImplementationSpecific
    - host: nightly.paylibero.net
      http:
        paths:
          - backend:
              service:
                name: pex-app
                port:
                  number: 8000
            path: /
            pathType: ImplementationSpecific
          - backend:
              service:
                name: core-laravel
                port:
                  number: 8000
            path: /api
            pathType: ImplementationSpecific
    - host: nightly.paylibero.de
      http:
        paths:
          - backend:
              service:
                name: pex-app
                port:
                  number: 8000
            path: /
            pathType: ImplementationSpecific
          - backend:
              service:
                name: core-laravel
                port:
                  number: 8000
            path: /api
            pathType: ImplementationSpecific
